<!-- public/stats.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –°–ú–ò</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #f8fafc 0%, #eef2ff 60%, #f8fafc 100%);
    }
    .chart-card {
      height: 100%;
    }
    .chart-container {
      height: 360px;
    }
    .summary-card {
      border: none;
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(4px);
      background: rgba(255, 255, 255, 0.85);
    }
    .summary-value {
      font-size: 2.4rem;
      font-weight: 700;
      line-height: 1;
    }
    .badge-soft {
      background: rgba(99, 102, 241, 0.1);
      color: #4c1d95;
    }
    .data-updated {
      font-size: 0.9rem;
      color: #475569;
    }
    @media (max-width: 767px) {
      .chart-container {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
      <div>
        <h1 class="fw-bold mb-1">üìä –ü–∞–Ω–µ–ª—å –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏—Ö –º–µ–¥–∏–∞</h1>
        <p class="text-muted mb-0">–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞</p>
      </div>
      <span class="data-updated" id="lastUpdated">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</span>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="p-4 summary-card h-100">
          <p class="text-uppercase text-muted small mb-2">–í—Å–µ–≥–æ —Å—Ç–∞—Ç–µ–π</p>
          <div class="summary-value text-primary" id="totalArticles">‚Äî</div>
          <span class="badge badge-soft mt-3">–°—É–º–º–∞ –ø–æ –≤—Å–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</span>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="p-4 summary-card h-100">
          <p class="text-uppercase text-muted small mb-2">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</p>
          <div class="summary-value text-success" id="activeSources">‚Äî</div>
          <span class="badge badge-soft mt-3">–°–∞–π—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏</span>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="p-4 summary-card h-100">
          <p class="text-uppercase text-muted small mb-2">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞</p>
          <div class="summary-value text-warning" id="avgLengthOverall">‚Äî</div>
          <span class="badge badge-soft mt-3">–°–∏–º–≤–æ–ª–æ–≤ –≤ –ø–æ–ª–Ω–æ–º —Ç–µ–∫—Å—Ç–µ</span>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-3">
      <div class="col-lg-6">
        <div class="card chart-card">
          <div class="card-header fw-semibold">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º</div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="uniqueChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card chart-card">
          <div class="card-header fw-semibold">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞ (—Å–∏–º–≤–æ–ª—ã)</div>
          <div class="card-body">
            <div class="chart-container">
            <canvas id="lengthChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-3">
      <div class="col-lg-8">
        <div class="card chart-card">
          <div class="card-header fw-semibold">–î–∏–Ω–∞–º–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π)</div>
      <div class="card-body">
            <div class="chart-container">
        <canvas id="timelineChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card chart-card">
          <div class="card-header fw-semibold">–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞</div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="contentChart"></canvas>
            </div>
            <div class="mt-3">
              <p class="mb-1 small text-muted">–í—Å–µ–≥–æ —Å—Ç–∞—Ç–µ–π: <span id="contentTotal">‚Äî</span></p>
              <p class="mb-1 small text-muted">–° –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º: <span id="contentWith">‚Äî</span></p>
              <p class="mb-0 small text-muted">–ë–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: <span id="contentWithout">‚Äî</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card chart-card">
          <div class="card-header fw-semibold">–ß–∞—Å—Ç–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="weekdayChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card chart-card">
          <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
            <span>–°–∞–º—ã–µ —á–∞—Å—Ç—ã–µ —Å–ª–æ–≤–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö</span>
            <small class="text-muted">300 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π</small>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="keywordsChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function formatNumber(value) {
      return typeof value === 'number'
        ? value.toLocaleString('ru-RU')
        : '‚Äî';
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`Request failed: ${url} (${res.status})`);
      }
      return res.json();
    }

    function setSummary({ totalArticles, activeSources, avgLength, contentStatus }) {
      document.getElementById('totalArticles').textContent = formatNumber(totalArticles);
      document.getElementById('activeSources').textContent = formatNumber(activeSources);
      document.getElementById('avgLengthOverall').textContent = formatNumber(avgLength);

      const totalContent = contentStatus.withContent + contentStatus.withoutContent;
      document.getElementById('contentTotal').textContent = formatNumber(totalContent);
      document.getElementById('contentWith').textContent = formatNumber(contentStatus.withContent);
      document.getElementById('contentWithout').textContent = formatNumber(contentStatus.withoutContent);
      document.getElementById('lastUpdated').textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleString('ru-RU')}`;
    }

    function buildSourcesChart(ctx, data) {
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.source),
          datasets: [{
            label: '–°—Ç–∞—Ç–µ–π —Å–æ–±—Ä–∞–Ω–æ',
            data: data.map(d => d.count),
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function buildLengthChart(ctx, data) {
      return new Chart(ctx, {
        type: 'radar',
        data: {
          labels: data.map(d => d.source),
          datasets: [{
            label: '–°—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ (—Å–∏–º–≤–æ–ª—ã)',
            data: data.map(d => d.avgLength),
            backgroundColor: 'rgba(75, 192, 192, 0.25)',
            borderColor: 'rgba(75, 192, 192, 0.8)',
            pointBackgroundColor: 'rgba(75, 192, 192, 1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { r: { beginAtZero: true } }
        }
      });
    }

    function buildUniqueChart(ctx, data) {
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.source),
          datasets: [{
            label: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—å–∏',
            data: data.map(d => d.uniqueCount),
            backgroundColor: 'rgba(59, 130, 246, 0.7)'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    }
    function buildTimelineChart(ctx, data) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.day),
          datasets: [{
            label: '–ù–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π –≤ –¥–µ–Ω—å',
            data: data.map(d => d.count),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.15)',
            fill: true,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function buildContentChart(ctx, contentStatus) {
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['–° –ø–æ–ª–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º', '–ë–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞'],
          datasets: [{
            data: [contentStatus.withContent, contentStatus.withoutContent],
            backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(148, 163, 184, 0.7)'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function buildWeekdayChart(ctx, data) {
      const weekdays = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => weekdays[d.dow]),
          datasets: [{
            label: '–ü—É–±–ª–∏–∫–∞—Ü–∏–π',
            data: data.map(d => d.count),
            backgroundColor: 'rgba(129, 140, 248, 0.7)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function buildKeywordsChart(ctx, data) {
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => d.word),
          datasets: [{
            label: '–£–ø–æ–º–∏–Ω–∞–Ω–∏–π –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö',
            data: data.map(d => d.count),
            backgroundColor: 'rgba(16, 185, 129, 0.7)'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { beginAtZero: true } }
        }
      });
    }

    async function loadDashboard() {
      try {
        const [
          sourcesData,
          lengthData,
          timelineData,
          weekdayData,
          keywordsData,
          contentStatus,
          uniqueData
        ] = await Promise.all([
          fetchJson('/api/stats/sources-count'),
          fetchJson('/api/stats/avg-content-length'),
          fetchJson('/api/stats/publications-daily'),
          fetchJson('/api/stats/publications-by-weekday'),
          fetchJson('/api/stats/top-title-words'),
          fetchJson('/api/stats/content-status'),
          fetchJson('/api/stats/unique-articles')
        ]);

        const totalArticles = sourcesData.reduce((acc, item) => acc + item.count, 0);
        const activeSources = sourcesData.length;
        const avgLength = lengthData.length
          ? Math.round(lengthData.reduce((acc, item) => acc + item.avgLength, 0) / lengthData.length)
          : 0;

        setSummary({ totalArticles, activeSources, avgLength, contentStatus });

        // buildSourcesChart(document.getElementById('sourcesChart'), sourcesData);
        buildLengthChart(document.getElementById('lengthChart'), lengthData);
        buildTimelineChart(document.getElementById('timelineChart'), timelineData);
        buildContentChart(document.getElementById('contentChart'), contentStatus);
        buildWeekdayChart(document.getElementById('weekdayChart'), weekdayData);
        buildKeywordsChart(document.getElementById('keywordsChart'), keywordsData);
        buildUniqueChart(document.getElementById('uniqueChart'), uniqueData);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–µ–ª–∏:', error);
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger mt-4';
        alert.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–∑–∂–µ.';
        document.querySelector('.container').appendChild(alert);
      }
    }

    loadDashboard();
  </script>
</body>
</html>